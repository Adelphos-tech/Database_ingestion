<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Analyser - Atlas IQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/plugins.css' />
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/css/luckysheet.css' />
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/plugins/js/plugin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@latest/dist/luckysheet.umd.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background: linear-gradient(135deg, #1a0b2e 0%, #16213e 50%, #0f3460 100%); min-height: 100vh; }
        .doc-split-container { display: grid; grid-template-columns: 40% 60%; gap: 0; height: 100vh; }
        .doc-ai-insights-panel { display: flex; flex-direction: column; background: #1a1a1a; border-right: 1px solid rgba(255,255,255,0.08); padding: 2rem 1.5rem; overflow-y: auto; }
        .doc-data-preview-panel { position: relative; display: flex; flex-direction: column; background: #ffffff; padding: 0; overflow: hidden; }
        .ai-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: rgba(16, 185, 129, 0.15); border-radius: 6px; color: #10b981; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.75rem; }
        .insights-title { display: flex; align-items: center; gap: 8px; color: #10b981; font-size: 14px; font-weight: 600; margin-bottom: 0.75rem; }
        .insight-item { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 10px 12px; margin-bottom: 8px; color: #d1d5db; font-size: 12px; line-height: 1.5; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- Header -->
    <div style="background: linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899); padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <span class="iconify" data-icon="fluent-emoji:clipboard" style="width:40px;height:40px;"></span>
            <div>
                <h1 style="font-size: 1.5rem; font-weight: 700; color: white; margin: 0; letter-spacing: -0.02em;">Document Analyser</h1>
                <p style="font-size: 0.875rem; color: rgba(255,255,255,0.9); margin: 0;">AI-powered analysis for Excel, PDF, DOCX, and TXT files</p>
            </div>
        </div>
        <button onclick="window.close()" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
            <span class="iconify" data-icon="fluent-emoji:cross-mark" style="width:16px;height:16px;display:inline;margin-right:4px;"></span>
            Close
        </button>
    </div>
    
    <div class="doc-split-container" style="height: calc(100vh - 80px);">
        <!-- Left Panel: AI Insights (40%) -->
        <div class="doc-ai-insights-panel">
            <div class="ai-badge">
                <span class="iconify" data-icon="fluent-emoji:robot" style="width:14px;height:14px;"></span>
                <span>Active Analysis</span>
            </div>
            
            <div id="aiInsightsSection" class="hidden">
                <div class="insights-title">
                    <span class="iconify" data-icon="fluent-emoji:light-bulb" style="width:14px;height:14px;"></span>
                    <span>Key Insights</span>
                </div>
                <div id="aiInsightsList"></div>
            </div>
            
            <div id="aiAnalysisSummary" style="color: #e8e8e8; font-size: 13px; line-height: 1.5; margin-bottom: 1rem;">
                Upload a document to start AI-powered analysis. I'll provide insights, trends, and visualizations automatically.
            </div>
            
            <div id="aiChartsSection" class="hidden"></div>
            
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <textarea id="docAnalyserQuestion" rows="2" class="w-full px-3 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded-lg focus:border-emerald-400 focus:ring-2 focus:ring-emerald-200 resize-none text-sm text-white placeholder-gray-400" placeholder="Ask follow-up questions..."></textarea>
                <button id="docAnalyserSendBtn" onclick="sendDocAnalyserQuestion()" class="w-full mt-2 px-4 py-2 rounded-lg bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-semibold shadow-lg hover:shadow-xl transition">
                    Ask AI ‚Üó
                </button>
            </div>
        </div>

        <!-- Right Panel: Data Preview (60%) -->
        <div class="doc-data-preview-panel">
            <!-- URL Input Section -->
            <div id="docUrlInputZone" class="mb-4 p-4 bg-gradient-to-r from-slate-50 to-indigo-50 rounded-xl border border-slate-200">
                <div class="flex items-center gap-3">
                    <div class="flex-shrink-0">
                        <span class="iconify" data-icon="fluent-emoji:globe-showing-americas" style="width:28px;height:28px;"></span>
                    </div>
                    <div class="flex-1">
                        <input type="url" id="docUrlInput" placeholder="Paste a URL to analyze (e.g., https://example.com/article)" 
                               class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                               onkeypress="if(event.key==='Enter') analyzeUrl()">
                    </div>
                    <button onclick="analyzeUrl()" class="flex-shrink-0 px-5 py-2.5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg font-semibold hover:from-indigo-500 hover:to-purple-500 transition shadow-lg hover:shadow-xl flex items-center gap-2">
                        <span class="iconify" data-icon="fluent-emoji:sparkles" style="width:20px;height:20px;"></span>
                        <span>Analyze</span>
                    </button>
                </div>
                <div class="mt-3 ml-10 flex items-start gap-2 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2">
                    <span class="iconify text-amber-600 flex-shrink-0" data-icon="fluent-emoji:warning" style="width:16px;height:16px;margin-top:2px;"></span>
                    <p class="text-xs text-amber-700">
                        <span class="font-semibold">Note:</span> Sites with heavy security (banking, e-commerce, protected portals) may not work.
                    </p>
                </div>
                <p class="text-xs text-slate-500 mt-2 ml-10">Or upload a file below</p>
            </div>
            
            <div id="docUploadZone" class="border-2 border-dashed border-slate-200 rounded-xl p-8 text-center hover:border-indigo-400 transition cursor-pointer bg-slate-50">
                <input type="file" id="docAnalyserFileInput" accept=".pdf,.docx,.doc,.txt,.xlsx,.xls,.csv" class="hidden">
                <div class="text-5xl mb-4"><span class="iconify" data-icon="fluent-emoji:page-facing-up" style="width:64px;height:64px;"></span></div>
                <p class="text-slate-700 mb-2">
                    <span class="text-indigo-600 font-semibold cursor-pointer" onclick="document.getElementById('docAnalyserFileInput').click()">Click to select a file</span> or drag and drop
                </p>
                <p class="text-xs text-slate-500">Supported: PDF, Excel (XLSX, XLS, CSV), DOCX, TXT</p>
            </div>
            
            <div id="docPreviewContent" class="hidden" style="position: absolute; top: 80px; left: 0; right: 0; bottom: 0; overflow: hidden;"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        const API_BASE_URL = 'https://database-ingestion-production.up.railway.app/api';
        console.log('üìä Doc Analyser loaded in new tab');
        
        // Doc Analyser Variables
        let currentDocData = null;
        let docConversationHistory = [];

        // Helper function to format error messages
        function formatErrorMessage(errorMsg) {
            const lowerMsg = errorMsg.toLowerCase();
            
            if (lowerMsg.includes('quota') || lowerMsg.includes('429') || lowerMsg.includes('rate limit')) {
                return 'üö´ API quota limit reached. Please try again later.';
            }
            if (lowerMsg.includes('api key') || lowerMsg.includes('unauthorized') || lowerMsg.includes('401')) {
                return 'üîë Authentication error. Please check API configuration.';
            }
            if (lowerMsg.includes('network') || lowerMsg.includes('fetch') || lowerMsg.includes('connection')) {
                return 'üåê Network error. Please check your connection.';
            }
            if (lowerMsg.includes('timeout')) {
                return '‚è±Ô∏è Request timeout. Please try again.';
            }
            return errorMsg;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // Initialize event listeners
        const docAnalyserFileInput = document.getElementById('docAnalyserFileInput');
        const docUploadZone = document.getElementById('docUploadZone');
        const docPreviewContent = document.getElementById('docPreviewContent');
        const docAnalyserQuestion = document.getElementById('docAnalyserQuestion');
        const docAnalyserSendBtn = document.getElementById('docAnalyserSendBtn');

        if (docAnalyserFileInput) {
            docAnalyserFileInput.addEventListener('change', handleDocAnalyserFile);
        }

        if (docUploadZone) {
            docUploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                docUploadZone.style.borderColor = 'rgba(124, 58, 237, 0.5)';
            });

            docUploadZone.addEventListener('dragleave', () => {
                docUploadZone.style.borderColor = 'rgba(148, 163, 184, 0.5)';
            });

            docUploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                docUploadZone.style.borderColor = 'rgba(148, 163, 184, 0.5)';
                if (docAnalyserFileInput) {
                    docAnalyserFileInput.files = e.dataTransfer.files;
                    handleDocAnalyserFile();
                }
            });
        }

        if (docAnalyserQuestion) {
            docAnalyserQuestion.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendDocAnalyserQuestion();
                }
            });
        }

        async function handleDocAnalyserFile() {
            const file = docAnalyserFileInput.files[0];
            if (!file) return;

            const fileName = file.name;
            const fileSize = formatFileSize(file.size);
            const fileExt = fileName.split('.').pop().toLowerCase();

            docUploadZone.classList.add('hidden');
            docPreviewContent.classList.remove('hidden');
            docPreviewContent.innerHTML = '<div style="text-align:center;padding:2rem;color:#d4d4d4;"><div style="font-size:3rem;">‚è≥</div><p>Loading document...</p></div>';
            
            document.getElementById('aiAnalysisSummary').innerHTML = '<div style="color:#10b981;"><div style="font-size:2rem;margin-bottom:1rem;">‚ú®</div><div>Analyzing Document...</div><div style="font-size:0.85rem;color:#6b7280;margin-top:0.5rem;">AI is processing your data...</div></div>';

            try {
                if (fileExt === 'xlsx' || fileExt === 'xls' || fileExt === 'csv') {
                    await handleExcelFile(file);
                } else if (fileExt === 'pdf') {
                    await handlePDFFile(file);
                } else if (fileExt === 'txt') {
                    await handleTextFile(file);
                } else if (fileExt === 'docx' || fileExt === 'doc') {
                    await handleDocxFile(file);
                } else {
                    throw new Error('Unsupported file format');
                }
            } catch (error) {
                docPreviewContent.innerHTML = `<div style="color:#ef4444;text-center;padding:2rem;">Error: ${error.message}</div>`;
                document.getElementById('aiAnalysisSummary').innerHTML = `<div style="color:#ef4444;">‚ö†Ô∏è Error: ${error.message}</div>`;
            }
        }

        async function handleExcelFile(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length > 0) {
                        docPreviewContent.innerHTML = '<div id="luckysheet" style="width:100%; height:100%; position:absolute; top:0; left:0;"></div>';
                        
                        const celldata = [];
                        jsonData.forEach((row, rowIndex) => {
                            row.forEach((cell, colIndex) => {
                                if (cell !== undefined && cell !== null && cell !== '') {
                                    celldata.push({
                                        r: rowIndex,
                                        c: colIndex,
                                        v: { v: cell, m: String(cell), ct: { fa: 'General', t: 'g' } }
                                    });
                                }
                            });
                        });

                        setTimeout(() => {
                            luckysheet.create({
                                container: 'luckysheet',
                                showinfobar: false,
                                showsheetbar: false,
                                showstatisticBar: false,
                                enableAddRow: false,
                                enableAddCol: false,
                                userInfo: false,
                                myFolderUrl: false,
                                allowEdit: false,
                                showToolbar: true,
                                showsheetbarConfig: { add: false, menu: false, sheet: true },
                                data: [{
                                    name: firstSheetName,
                                    celldata: celldata,
                                    row: jsonData.length,
                                    column: Math.max(...jsonData.map(row => row.length))
                                }],
                                title: file.name,
                                lang: 'en'
                            });
                        }, 100);

                        currentDocData = {
                            type: 'excel',
                            data: jsonData,
                            rows: jsonData.length - 1,
                            columns: jsonData[0].length,
                            headers: jsonData[0]
                        };

                        await analyzeDocument(file, 'excel', jsonData);
                    }
                } catch (error) {
                    throw new Error('Failed to parse Excel file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function handlePDFFile(file) {
            const fileURL = URL.createObjectURL(file);
            docPreviewContent.innerHTML = `<iframe src="${fileURL}" style="width:100%;height:100%;border:0;"></iframe>`;
            await analyzeDocument(file, 'pdf');
        }

        async function handleTextFile(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                docPreviewContent.innerHTML = `<pre style="white-space:pre-wrap;font-size:13px;color:#d4d4d4;background:#0f0f0f;padding:1rem;border-radius:8px;height:100%;overflow:auto;">${text}</pre>`;
                
                currentDocData = { type: 'text', content: text };
                await analyzeDocument(file, 'text', text);
            };
            reader.readAsText(file);
        }

        async function handleDocxFile(file) {
            docPreviewContent.innerHTML = '<div style="color:#d4d4d4;text-center;padding:2rem;">üìÑ DOCX file loaded. Use AI chat to analyze.</div>';
            await analyzeDocument(file, 'docx');
        }

        async function analyzeDocument(file, fileType, parsedData = null) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('file_type', fileType);
            
            if (fileType === 'excel' && parsedData) {
                formData.append('excel_data', JSON.stringify({
                    rows: parsedData.length - 1,
                    columns: parsedData[0].length,
                    headers: parsedData[0],
                    sample_data: parsedData.slice(1, 6)
                }));
            } else if (fileType === 'text' && parsedData) {
                formData.append('text_content', parsedData);
            }

            try {
                const response = await fetch(`${API_BASE_URL}/analyse-document`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    displayAnalysis(data.analysis, data.data_summary);
                    docConversationHistory = [];
                } else {
                    throw new Error(data.error || 'Analysis failed');
                }
            } catch (error) {
                const errorMessage = formatErrorMessage(error.message);
                document.getElementById('aiAnalysisSummary').innerHTML = `<div style="color:#ef4444;font-size:13px;">‚ö†Ô∏è ${errorMessage}</div>`;
            }
        }

        function displayAnalysis(analysis, dataSummary = null) {
            const lines = analysis.split('\n');
            let summary = '';
            let insights = [];
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;
                
                if (line.startsWith('-') || line.startsWith('‚Ä¢') || line.startsWith('*') || line.match(/^\d+\./)) {
                    insights.push(line.replace(/^[-‚Ä¢*]\s*/, '').replace(/^\d+\.\s*/, ''));
                } else if (insights.length === 0) {
                    summary += line + ' ';
                }
            }
            
            document.getElementById('aiAnalysisSummary').textContent = summary || "I've analyzed your data.";
            
            if (insights.length > 0) {
                document.getElementById('aiInsightsSection').classList.remove('hidden');
                const insightsList = document.getElementById('aiInsightsList');
                insightsList.innerHTML = insights.map(insight => {
                    const highlighted = insight.replace(/(\$?[\d,]+\.?\d*%?)/g, '<strong>$1</strong>');
                    return `<div class="insight-item">${highlighted}</div>`;
                }).join('');
            }
        }

        async function sendDocAnalyserQuestion() {
            const question = docAnalyserQuestion.value.trim();
            if (!question || !currentDocData) return;

            docAnalyserSendBtn.disabled = true;
            docAnalyserSendBtn.textContent = 'Thinking...';

            try {
                const formData = new FormData();
                formData.append('question', question);
                formData.append('file_type', currentDocData.type);
                formData.append('conversation_history', JSON.stringify(docConversationHistory));
                
                if (currentDocData.type === 'excel') {
                    formData.append('excel_data', JSON.stringify(currentDocData.data));
                } else if (currentDocData.type === 'text') {
                    formData.append('text_content', currentDocData.content);
                }

                const response = await fetch(`${API_BASE_URL}/analyse-document`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success && data.answer) {
                    document.getElementById('aiAnalysisSummary').innerHTML = `
                        <div style="margin-bottom:1rem;padding:0.75rem;background:rgba(16,185,129,0.1);border-left:3px solid #10b981;border-radius:4px;">
                            <div style="color:#10b981;font-size:11px;font-weight:600;margin-bottom:0.5rem;">YOU</div>
                            <div style="color:#d4d4d4;font-size:13px;">${question}</div>
                        </div>
                        <div style="padding:0.75rem;background:rgba(99,102,241,0.1);border-left:3px solid #6366f1;border-radius:4px;">
                            <div style="color:#6366f1;font-size:11px;font-weight:600;margin-bottom:0.5rem;">AI</div>
                            <div style="color:#d4d4d4;font-size:13px;">${data.answer}</div>
                        </div>
                    `;
                    
                    docConversationHistory.push({ user: question, assistant: data.answer });
                    docAnalyserQuestion.value = '';
                } else {
                    throw new Error(data.error || 'Failed to get answer');
                }
            } catch (error) {
                const errorMessage = formatErrorMessage(error.message);
                document.getElementById('aiAnalysisSummary').innerHTML = `<div style="color:#ef4444;font-size:13px;">‚ö†Ô∏è ${errorMessage}</div>`;
            } finally {
                docAnalyserSendBtn.disabled = false;
                docAnalyserSendBtn.textContent = 'Ask AI ‚Üó';
            }
        }

        async function analyzeUrl() {
            const urlInput = document.getElementById('docUrlInput');
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('Please enter a URL');
                return;
            }
            
            try {
                new URL(url);
            } catch (e) {
                alert('Please enter a valid URL');
                return;
            }
            
            docUploadZone.classList.add('hidden');
            docPreviewContent.classList.remove('hidden');
            
            document.getElementById('aiAnalysisSummary').innerHTML = '<div style="color:#10b981;"><div style="font-size:2rem;margin-bottom:1rem;">üåê</div><div>Fetching Web Content...</div></div>';
            docPreviewContent.innerHTML = `<iframe src="${url}" style="width:100%;height:100%;border:0;background:#fff;"></iframe>`;
            
            try {
                const formData = new FormData();
                formData.append('url', url);
                formData.append('file_type', 'url');
                
                const response = await fetch(`${API_BASE_URL}/analyse-document`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success && data.analysis) {
                    currentDocData = { type: 'url', url: url, content: data.text_content || '' };
                    displayAnalysis(data.analysis, data.summary);
                } else {
                    throw new Error(data.error || 'Failed to analyze URL');
                }
            } catch (error) {
                let errorMessage = error.message || 'Unknown error occurred';
                if (errorMessage.includes('403') || errorMessage.includes('blocked')) {
                    errorMessage = 'üîí Website blocked access';
                } else if (errorMessage.includes('404')) {
                    errorMessage = '‚ùå Page not found';
                }
                
                document.getElementById('aiAnalysisSummary').innerHTML = `<div style="color:#ef4444;font-size:13px;">‚ö†Ô∏è ${errorMessage}</div>`;
            }
        }

        console.log('‚úÖ Doc Analyser fully loaded with all functions');
    </script>
</body>
</html>
