<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Analyzer - Atlas IQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: #0A0A0F;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Figma Background */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: linear-gradient(to bottom right, rgb(99 102 241 / 0.05), rgb(168 85 247 / 0.05), rgb(236 72 153 / 0.05));
            z-index: 0;
            pointer-events: none;
        }
        
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at top, rgb(79 70 229 / 0.1), transparent 50%);
            z-index: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header style="
        background: rgba(10, 10, 15, 0.8);
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        padding: 1.25rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        position: sticky;
        top: 0;
        z-index: 50;
    ">
        <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div style="position: relative;">
                <div style="position: absolute; inset: 0; background: linear-gradient(to top right, rgb(99 102 241), rgb(168 85 247), rgb(236 72 153)); border-radius: 0.5rem; filter: blur(12px); opacity: 0.75;"></div>
                <div style="position: relative; background: linear-gradient(to top right, rgb(99 102 241), rgb(168 85 247), rgb(236 72 153)); padding: 0.625rem; border-radius: 0.5rem;">
                    <span class="iconify" data-icon="fluent:document-text-24-filled" style="width:20px;height:20px;color:white;"></span>
                </div>
            </div>
            <div>
                <h1 style="font-size: 1.125rem; font-weight: 400; color: rgba(255, 255, 255, 0.95); margin: 0; letter-spacing: -0.025em;">Document Analyzer</h1>
                <p style="font-size: 11px; color: rgba(255, 255, 255, 0.4); margin: 0; font-weight: 500; text-transform: uppercase; letter-spacing: 0.025em; margin-top: 2px;">AI-Powered Intelligence</p>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 0.75rem;">
            <button onclick="location.reload()" style="background: white; color: #0A0A0F; border: none; padding: 0.625rem 1.25rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 8px 16px rgba(255, 255, 255, 0.1);">
                <span class="iconify" data-icon="ph:plus" style="width:16px;height:16px;"></span>
                <span>New Document</span>
            </button>
        </div>
    </header>

    <!-- Main Layout: Sidebar + Content -->
    <div style="display: flex; height: calc(100vh - 73px);">
        
        <!-- Sidebar (Figma Style - 384px width) -->
        <aside style="width: 384px; border-right: 1px solid rgba(255, 255, 255, 0.05); background: rgba(10, 10, 15, 0.4); backdrop-filter: blur(40px); display: flex; flex-direction: column;">
            
            <!-- Scrollable Content -->
            <div style="flex: 1; overflow-y: auto; padding: 2rem;">
                
                <!-- Status Badge -->
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                    <div style="width: 6px; height: 6px; border-radius: 50%; background: rgb(99 102 241); animation: pulse 2s infinite;"></div>
                    <span style="font-size: 10px; letter-spacing: 0.1em; color: rgba(255, 255, 255, 0.3); text-transform: uppercase;">Active Analysis</span>
                </div>

                <!-- Info Card -->
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem;">
                    <p style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.6); line-height: 1.6;">
                        Upload a document to begin AI-powered analysis. Get insights, trends, and visualizations in seconds.
                    </p>
                </div>

                <!-- Capabilities -->
                <p style="font-size: 10px; letter-spacing: 0.1em; color: rgba(255, 255, 255, 0.3); text-transform: uppercase; margin-bottom: 1rem;">Capabilities</p>
                
                <!-- Capability Cards -->
                <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 2rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 0.75rem; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.04)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.02)'">
                        <div style="position: relative;">
                            <div style="position: absolute; inset: 0; background: linear-gradient(to bottom right, rgb(99 102 241), rgb(139 92 246)); border-radius: 0.5rem; filter: blur(8px); opacity: 0.5;"></div>
                            <div style="position: relative; background: linear-gradient(to bottom right, rgb(99 102 241), rgb(139 92 246)); padding: 0.625rem; border-radius: 0.5rem;">
                                <span class="iconify" data-icon="ph:trending-up" style="width:16px;height:16px;color:white;"></span>
                            </div>
                        </div>
                        <div style="flex: 1;">
                            <p style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.9); margin-bottom: 0.125rem;">Trend Analysis</p>
                            <p style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.4);">Pattern recognition</p>
                        </div>
                        <span class="iconify" data-icon="ph:arrow-up-right" style="width:16px;height:16px;color:rgba(255,255,255,0.2);"></span>
                    </div>

                    <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 0.75rem; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.04)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.02)'">
                        <div style="position: relative;">
                            <div style="position: absolute; inset: 0; background: linear-gradient(to bottom right, rgb(168 85 247), rgb(236 72 153)); border-radius: 0.5rem; filter: blur(8px); opacity: 0.5;"></div>
                            <div style="position: relative; background: linear-gradient(to bottom right, rgb(168 85 247), rgb(236 72 153)); padding: 0.625rem; border-radius: 0.5rem;">
                                <span class="iconify" data-icon="ph:file-text" style="width:16px;height:16px;color:white;"></span>
                            </div>
                        </div>
                        <div style="flex: 1;">
                            <p style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.9); margin-bottom: 0.125rem;">Smart Summaries</p>
                            <p style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.4);">Key insights extraction</p>
                        </div>
                        <span class="iconify" data-icon="ph:arrow-up-right" style="width:16px;height:16px;color:rgba(255,255,255,0.2);"></span>
                    </div>

                    <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 0.75rem; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.04)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.02)'">
                        <div style="position: relative;">
                            <div style="position: absolute; inset: 0; background: linear-gradient(to bottom right, rgb(236 72 153), rgb(239 68 68)); border-radius: 0.5rem; filter: blur(8px); opacity: 0.5;"></div>
                            <div style="position: relative; background: linear-gradient(to bottom right, rgb(236 72 153), rgb(239 68 68)); padding: 0.625rem; border-radius: 0.5rem;">
                                <span class="iconify" data-icon="ph:lightning" style="width:16px;height:16px;color:white;"></span>
                            </div>
                        </div>
                        <div style="flex: 1;">
                            <p style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.9); margin-bottom: 0.125rem;">Real-time Processing</p>
                            <p style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.4);">Instant analysis</p>
                        </div>
                        <span class="iconify" data-icon="ph:arrow-up-right" style="width:16px;height:16px;color:rgba(255,255,255,0.2);"></span>
                    </div>
                </div>
            </div>

            <!-- Chat Input (Bottom) -->
            <div style="padding: 2rem; border-top: 1px solid rgba(255, 255, 255, 0.05); position: relative;">
                <p style="font-size: 10px; letter-spacing: 0.1em; color: rgba(255, 255, 255, 0.3); text-transform: uppercase; margin-bottom: 1rem;">Ask Questions</p>
                
                <div style="display: flex; align-items: center; gap: 0.5rem; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 0.75rem; padding: 0.5rem;">
                    <input type="text" placeholder="Type your question..." style="flex: 1; background: transparent; border: none; outline: none; padding: 0.5rem; color: rgba(255, 255, 255, 0.9); font-size: 0.875rem;">
                    
                    <!-- Model Selector Button -->
                    <button id="modelSelectorBtn" onclick="toggleModelDropdown()" style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 0.5rem; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.05)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.02)'">
                        <div style="width: 6px; height: 6px; border-radius: 50%; background: rgb(99 102 241);"></div>
                    </button>

                    <button style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: linear-gradient(to right, rgb(99 102 241), rgb(168 85 247), rgb(236 72 153)); border: none; border-radius: 0.5rem; cursor: pointer; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);">
                        <span class="iconify" data-icon="ph:paper-plane-tilt" style="width:16px;height:16px;color:white;"></span>
                    </button>
                </div>

                <!-- Model Dropdown -->
                <div id="modelDropdown" style="display: none; position: absolute; bottom: 100%; left: 2rem; right: 2rem; margin-bottom: 0.5rem; background: rgba(22, 22, 31, 0.95); backdrop-filter: blur(40px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.75rem; padding: 0.5rem; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5); max-height: 320px; overflow-y: auto;">
                    <div onclick="selectModel('Gemini 2.5 Flash')" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.05)'" onmouseout="this.style.background='transparent'">
                        <div style="width: 6px; height: 6px; border-radius: 50%; background: rgb(99 102 241);"></div>
                        <div style="flex: 1;">
                            <p style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.9); margin: 0; font-weight: 500;">Gemini 2.5 Flash</p>
                            <p style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.4); margin: 0;">Balanced speed and quality</p>
                        </div>
                        <span style="font-size: 10px; color: rgba(255, 255, 255, 0.4); text-transform: uppercase; letter-spacing: 0.05em;">Current</span>
                    </div>
                    
                    <div onclick="selectModel('Gemini 2.0 Ultra')" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.05)'" onmouseout="this.style.background='transparent'">
                        <div style="width: 6px; height: 6px; border-radius: 50%; background: rgb(168 85 247);"></div>
                        <div style="flex: 1;">
                            <p style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.9); margin: 0; font-weight: 500;">Gemini 2.0 Ultra</p>
                            <p style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.4); margin: 0;">Highest quality and reasoning</p>
                        </div>
                    </div>
                    
                    <div onclick="selectModel('GPT-4 Turbo')" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255, 255, 255, 0.05)'" onmouseout="this.style.background='transparent'">
                        <div style="width: 6px; height: 6px; border-radius: 50%; background: rgb(236 72 153);"></div>
                        <div style="flex: 1;">
                            <p style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.9); margin: 0; font-weight: 500;">GPT-4 Turbo</p>
                            <p style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.4); margin: 0;">OpenAI's most capable</p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main style="flex: 1; overflow-y: auto;">
            <div style="max-width: 1400px; margin: 0 auto; padding: 4rem 3rem;">
                
                <!-- URL Input -->
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 2rem;">
                    <div style="display: flex; align-items: center; justify-content: center; width: 48px; height: 48px; background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 0.75rem;">
                        <span class="iconify" data-icon="ph:link" style="width:20px;height:20px;color:rgb(99 102 241);"></span>
                    </div>
                    <div style="flex: 1;">
                        <input type="url" placeholder="Paste a URL to analyze (e.g., https://example.com/document)" style="width: 100%; padding: 0.875rem 1rem; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 0.75rem; outline: none; color: rgba(255, 255, 255, 0.9); font-size: 0.875rem;">
                    </div>
                    <button onclick="analyzeURL()" style="padding: 0.875rem 1.5rem; background: linear-gradient(to right, rgb(99 102 241), rgb(168 85 247), rgb(236 72 153)); color: white; border: none; border-radius: 0.75rem; font-weight: 600; font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 8px 16px rgba(99, 102, 241, 0.25);">
                        <span class="iconify" data-icon="ph:sparkles" style="width:18px;height:18px;"></span>
                        <span>Analyze</span>
                    </button>
                </div>

                <!-- Warning Note -->
                <div style="display: flex; align-items: start; gap: 0.5rem; margin-left: 60px; padding: 0.75rem 1rem; background: rgba(251, 146, 60, 0.08); border: 1px solid rgba(251, 146, 60, 0.2); border-radius: 0.5rem; margin-bottom: 3rem;">
                    <span class="iconify" data-icon="ph:warning" style="width:16px;height:16px;color:#fb923c;margin-top:2px;"></span>
                    <p style="font-size: 0.75rem; color: #fbbf24; margin: 0;"><strong>Note:</strong> Sites with heavy security (banking, e-commerce, protected portals) may not work.</p>
                </div>

                <!-- Divider -->
                <div style="position: relative; margin: 3rem 0;">
                    <div style="position: absolute; inset: 0; display: flex; align-items: center;">
                        <div style="width: 100%; border-top: 1px solid rgba(255, 255, 255, 0.05);"></div>
                    </div>
                    <div style="position: relative; display: flex; justify-center;">
                        <span style="padding: 0 1.5rem; background: #0A0A0F; font-size: 0.75rem; color: rgba(255, 255, 255, 0.3); text-transform: uppercase; letter-spacing: 0.1em;">Or upload a file</span>
                    </div>
                </div>

                <!-- File Upload Zone -->
                <div onclick="console.log('🎯 Upload zone clicked'); document.getElementById('fileInput').click();" style="border: 2px dashed rgba(255, 255, 255, 0.1); border-radius: 1.5rem; padding: 5rem 3rem; text-align: center; cursor: pointer; transition: all 0.3s; background: rgba(255, 255, 255, 0.01);" onmouseover="this.style.borderColor='rgba(255, 255, 255, 0.2)'; this.style.background='rgba(255, 255, 255, 0.02)';" onmouseout="this.style.borderColor='rgba(255, 255, 255, 0.1)'; this.style.background='rgba(255, 255, 255, 0.01)';">
                    <input type="file" accept=".pdf,.xlsx,.xls,.csv,.docx,.txt" style="display: none;" id="fileInput">
                    
                    <!-- Icon with Gradient Glow -->
                    <div style="display: inline-block; position: relative; margin-bottom: 2rem;">
                        <div style="position: absolute; inset: 0; background: linear-gradient(to bottom right, rgb(99 102 241), rgb(168 85 247), rgb(236 72 153)); border-radius: 1rem; filter: blur(24px); opacity: 0.4;"></div>
                        <div style="position: relative; background: rgba(255, 255, 255, 0.05); padding: 2rem; border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <span class="iconify" data-icon="ph:file-text" style="width:64px;height:64px;color:rgba(255,255,255,0.9);"></span>
                        </div>
                    </div>

                    <p style="font-size: 1.125rem; color: rgba(255, 255, 255, 0.9); margin-bottom: 1rem;">
                        <span style="background: linear-gradient(to right, rgb(99 102 241), rgb(168 85 247), rgb(236 72 153)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; cursor: pointer;" onclick="console.log('📁 Click to select clicked'); document.getElementById('fileInput').click();">Click to select</span>
                        <span style="color: rgba(255, 255, 255, 0.4);"> or drag and drop</span>
                    </p>
                    
                    <p style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.3); margin: 0;">Supported formats: PDF, Excel (XLSX, XLS), CSV, DOCX, TXT</p>
                </div>

            </div>
        </main>
    </div>

    <script>
        const API_BASE_URL = 'https://database-ingestion-production.up.railway.app';
        console.log('✨ Figma Design Loaded - Backend Connected');

        // Document State
        let currentDocData = null;
        let docConversationHistory = [];

        // Toggle Model Dropdown
        function toggleModelDropdown() {
            console.log('🔵 Toggle model dropdown clicked');
            const dropdown = document.getElementById('modelDropdown');
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                // Animate in
                dropdown.style.opacity = '0';
                dropdown.style.transform = 'translateY(10px)';
                setTimeout(() => {
                    dropdown.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                    dropdown.style.opacity = '1';
                    dropdown.style.transform = 'translateY(0)';
                }, 10);
            } else {
                dropdown.style.opacity = '0';
                dropdown.style.transform = 'translateY(10px)';
                setTimeout(() => {
                    dropdown.style.display = 'none';
                }, 300);
            }
        }

        // Select Model
        async function selectModel(modelName) {
            console.log('Selected model:', modelName);
            
            // Map model names to IDs
            const modelMap = {
                'Gemini 2.5 Flash': 'models/gemini-2.5-flash',
                'Gemini 2.0 Ultra': 'models/gemini-2.0-ultra',
                'GPT-4 Turbo': 'models/gpt-4-turbo'
            };
            
            const modelId = modelMap[modelName] || 'models/gemini-2.5-flash';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/model`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: modelId })
                });
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Server error');
                }
                
                const data = await response.json();
                if (data.success) {
                    showNotification(`✨ Switched to ${modelName}`);
                } else {
                    throw new Error('Switch failed');
                }
            } catch (error) {
                console.error('Error switching model:', error);
                showNotification('⚠️ Backend offline - using default');
            }
            
            // Close dropdown
            toggleModelDropdown();
        }
        
        function showNotification(message) {
            const notif = document.createElement('div');
            notif.style.cssText = 'position: fixed; top: 1rem; right: 1rem; background: linear-gradient(to right, rgb(99 102 241), rgb(168 85 247)); color: white; padding: 0.75rem 1.25rem; border-radius: 0.75rem; font-size: 0.875rem; font-weight: 500; z-index: 9999; box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);';
            notif.textContent = message;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.transition = 'opacity 0.3s';
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }, 2500);
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('modelDropdown');
            const btn = document.getElementById('modelSelectorBtn');
            if (dropdown && dropdown.style.display !== 'none' && !dropdown.contains(e.target) && !btn.contains(e.target)) {
                toggleModelDropdown();
            }
        });

        // File Upload Handler
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.addEventListener('change', handleFileUpload);
            console.log('✅ File input connected');
        } else {
            console.error('❌ File input not found');
        }

        async function handleFileUpload(event) {
            console.log('📂 handleFileUpload called', event);
            const file = event.target.files[0];
            console.log('📄 File:', file);
            if (!file) {
                console.log('⚠️ No file selected');
                return;
            }

            showNotification('📁 Processing file...');

            const fileName = file.name;
            const fileExt = fileName.split('.').pop().toLowerCase();

            try {
                if (fileExt === 'xlsx' || fileExt === 'xls' || fileExt === 'csv') {
                    await handleExcelFile(file);
                } else if (fileExt === 'pdf') {
                    await handlePDFFile(file);
                } else if (fileExt === 'docx' || fileExt === 'doc') {
                    await handleDocxFile(file);
                } else if (fileExt === 'txt') {
                    await handleTextFile(file);
                } else {
                    throw new Error('Unsupported file type');
                }
            } catch (error) {
                console.error('Error processing file:', error);
                showNotification('❌ Error processing file');
            }
        }

        async function handleExcelFile(file) {
            console.log('📊 handleExcelFile started for:', file.name);
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    console.log('📖 FileReader onload triggered');
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    console.log('📚 Workbook loaded, sheets:', workbook.SheetNames);
                    
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    console.log('📋 JSON data extracted, rows:', jsonData.length);

                    if (!jsonData || jsonData.length === 0) {
                        throw new Error('Empty spreadsheet');
                    }

                    currentDocData = {
                        type: 'excel',
                        name: file.name,
                        data: jsonData,
                        headers: jsonData[0],
                        rows: jsonData.length - 1
                    };
                    console.log('💾 Document data stored');

                    console.log('🚀 Calling analyzeDocument...');
                    await analyzeDocument(file, 'excel', jsonData);
                } catch (error) {
                    console.error('❌ Excel processing error:', error);
                    showNotification('❌ Error reading Excel file');
                }
            };
            console.log('📂 Starting to read file as ArrayBuffer');
            reader.readAsArrayBuffer(file);
        }

        async function handlePDFFile(file) {
            showNotification('📄 PDF support coming soon...');
            // PDF.js integration would go here
        }

        async function handleDocxFile(file) {
            showNotification('📝 DOCX support coming soon...');
            // Mammoth.js integration would go here
        }

        async function handleTextFile(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const textContent = e.target.result;
                currentDocData = {
                    type: 'text',
                    name: file.name,
                    content: textContent
                };
                await analyzeDocument(file, 'text', { content: textContent });
            };
            reader.readAsText(file);
        }

        async function analyzeDocument(file, fileType, parsedData) {
            console.log('🤖 analyzeDocument called');
            console.log('  File:', file.name);
            console.log('  Type:', fileType);
            console.log('  API URL:', `${API_BASE_URL}/api/analyse-document`);
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('file_type', fileType);

            if (fileType === 'excel') {
                const excelMetadata = {
                    rows: parsedData.length - 1,
                    columns: parsedData[0].length,
                    headers: parsedData[0],
                    sample_data: parsedData.slice(1, 6)
                };
                console.log('📊 Excel metadata:', excelMetadata);
                formData.append('excel_data', JSON.stringify(excelMetadata));
            } else if (fileType === 'text') {
                formData.append('text_content', parsedData.content);
            }

            try {
                console.log('📡 Sending POST request to backend...');
                showNotification('🤖 Sending to Gemini...');
                
                const response = await fetch(`${API_BASE_URL}/api/analyse-document`, {
                    method: 'POST',
                    body: formData
                });

                console.log('📥 Response received:', response.status, response.statusText);

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('❌ Invalid content type:', contentType);
                    throw new Error('Server error - Backend may be offline');
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('📊 API Response:', data);

                if (data.success) {
                    console.log('✅ Analysis successful!');
                    displayAnalysis(data.analysis);
                    showNotification('✨ Analysis complete!');
                } else {
                    console.error('❌ Analysis failed:', data.error);
                    throw new Error(data.error || 'Analysis failed');
                }
            } catch (error) {
                console.error('❌ Analysis error:', error);
                showNotification('❌ ' + error.message);
            }
        }

        function displayAnalysis(analysis) {
            console.log('📊 Displaying analysis:', analysis);
            
            // Find the info card in sidebar (the one that says "Upload a document...")
            const infoCard = document.querySelector('.doc-ai-insights-panel') || 
                           document.querySelector('aside > div:first-child');
            
            if (!infoCard) {
                console.error('❌ Could not find sidebar to display results');
                return;
            }

            // Create analysis display HTML
            let analysisHTML = '<div style="padding: 2rem;">';
            
            // Title
            analysisHTML += '<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">';
            analysisHTML += '<span style="font-size: 1.5rem;">✨</span>';
            analysisHTML += '<h3 style="color: rgba(255, 255, 255, 0.9); font-size: 1.125rem; font-weight: 600; margin: 0;">AI Analysis Complete</h3>';
            analysisHTML += '</div>';

            // Analysis content
            if (typeof analysis === 'string') {
                // Simple string analysis
                analysisHTML += `<div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1rem;">`;
                analysisHTML += `<p style="color: rgba(255, 255, 255, 0.8); line-height: 1.6; margin: 0; white-space: pre-wrap;">${analysis}</p>`;
                analysisHTML += `</div>`;
            } else if (analysis && typeof analysis === 'object') {
                // Object analysis - display key insights
                if (analysis.summary) {
                    analysisHTML += `<div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1rem;">`;
                    analysisHTML += `<h4 style="color: rgba(255, 255, 255, 0.9); font-size: 0.875rem; font-weight: 600; margin: 0 0 0.75rem 0;">Summary</h4>`;
                    analysisHTML += `<p style="color: rgba(255, 255, 255, 0.7); line-height: 1.6; margin: 0;">${analysis.summary}</p>`;
                    analysisHTML += `</div>`;
                }
                
                if (analysis.insights && Array.isArray(analysis.insights)) {
                    analysisHTML += `<h4 style="color: rgba(255, 255, 255, 0.9); font-size: 0.875rem; font-weight: 600; margin: 0 0 0.75rem 0;">Key Insights</h4>`;
                    analysis.insights.forEach(insight => {
                        analysisHTML += `<div style="background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem;">`;
                        analysisHTML += `<p style="color: rgba(255, 255, 255, 0.8); font-size: 0.875rem; line-height: 1.5; margin: 0;">${insight}</p>`;
                        analysisHTML += `</div>`;
                    });
                }

                // Display raw object if no specific fields
                if (!analysis.summary && !analysis.insights) {
                    analysisHTML += `<div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 1rem; padding: 1.5rem;">`;
                    analysisHTML += `<pre style="color: rgba(255, 255, 255, 0.7); font-size: 0.8rem; line-height: 1.5; margin: 0; overflow-x: auto; white-space: pre-wrap;">${JSON.stringify(analysis, null, 2)}</pre>`;
                    analysisHTML += `</div>`;
                }
            }

            analysisHTML += '</div>';

            // Update the sidebar - replace the scrollable content
            const scrollArea = infoCard.querySelector('.flex-1') || infoCard;
            if (scrollArea) {
                scrollArea.innerHTML = analysisHTML;
            }

            showNotification('📊 Analysis displayed in sidebar');
        }

        // URL Analysis
        async function analyzeURL() {
            console.log('🌐 Analyze URL clicked');
            const urlInput = document.querySelector('input[type="url"]');
            const url = urlInput?.value?.trim();
            console.log('URL value:', url);
            
            if (!url) {
                showNotification('⚠️ Please enter a URL');
                return;
            }

            showNotification('🌐 Analyzing URL...');

            try {
                const formData = new FormData();
                formData.append('url', url);
                formData.append('file_type', 'url');

                const response = await fetch(`${API_BASE_URL}/api/analyse-document`, {
                    method: 'POST',
                    body: formData
                });

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Server error');
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.analysis) {
                    displayAnalysis(data.analysis);
                    showNotification('✨ URL analyzed successfully!');
                } else {
                    throw new Error(data.error || 'Analysis failed');
                }
            } catch (error) {
                console.error('URL analysis error:', error);
                showNotification('❌ ' + error.message);
            }
        }

        console.log('✅ All backend functionality loaded');
    </script>
</body>
</html>
